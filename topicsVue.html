<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <title>WorldViews Projects</title>

    <style>
        .intro {
            background-color: rgb(208, 232, 253);
            text-align: center;
            padding-top: 30px;
            padding-right: 15%;
            padding-left: 15%;
            padding-bottom: 20px;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        body {
            background-color: aliceblue;
            padding: 0px;
            margin: 0px;
        }

        .grid {
            width: 98%;
            xxborder-style: solid;
            xxborder-width: 2px;
            padding: 4px;
            margin: 0 auto;
            /* necessary for masonry to center cols */
        }

        .grid-item {
            width: 440px;
            xwidth: 95%;
            border-style: solid;
            border-width: 2px;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            margin-left: 10px;
            background-color: white;
        }

        /* this applies to images inside grid-items */
        .grid-item img {
            xxborder-style: solid;
            xxborder-width: 3px;
            border-radius: 5px;
            margin-left: 15px;
            margin-bottom: 15px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/masonry-layout@4.1/dist/masonry.pkgd.js"></script>
    <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-database.js"></script>
    <script src="js/libs/tinymce_4.9.11/js/tinymce/tinymce.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="js/util.js"></script>
    <script src="js/sprintf.js"></script>
    <script src="js/WVTopicsDB.js"></script>
</head>

<body>
    <header>
    </header>
    <main role="main">
        <span style="float:right; padding:5px">
            <span id="userInfo">guest</span>
            &nbsp;&nbsp;
            <button id="login">login</button>
        </span>
        <img src="images/holding-hands-heart-shaped-earth-t.png" style="float:left; width: 150px; margin:20px;">

        <section class="intro">
            <h1 style="font-size: xx-large;">WorldViews Projects and Collaborations</h1>
            <p>This is a project list, for experimenting with View.</p>
        </section>
    </main>
    <div id="app">
        <h2>{{title}}</h2>
        <div class="grid">
            <div v-for="topic in getTopics({contains:'School'})">
                {{topic.name}} - {{topic.id}} <br>
                <div class="grid-item">
                    {{topic.name}}
                    <div v-html="topic.description" v-bind:id="topic.id"></div>
                    <br>
                    <div v-if="editState(topic.id) != 'edit'">
                        <button @click="editTopic(topic,'edit')">Edit</button>
                    </div>
                    <div v-else>
                        Tags: {{ topic.tags }}
                        <button @click="editTopic(topic,'save')">Save</button>                        
                    </div>
                </div>
                <!-- {{item.description}} -->
                <p></p>
            </div>
        </div>

        <div class="grid">
            <div v-for="topic in getTopics({contains:'School'})">
                {{topic.name}} - {{topic.id}} <br>
                <div class="grid-item">
                    {{topic.name}}
                    <div v-html="topic.description" v-bind:id="topic.id"></div>
                    <br>
                    <div v-if="editState(topic.id) != 'edit'">
                        <button @click="editTopic(topic,'edit')">Edit</button>
                    </div>
                    <div v-else>
                        Tags: {{ topic.tags }}
                        <button @click="editTopic(topic,'save')">Save</button>                        
                    </div>
                </div>
                <!-- {{item.description}} -->
                <p></p>
            </div>
        </div>

        <h2>Projects matching "School"</h2>
        <template v-for="topic in getTopics({contains:'School'})">
            <div>
                {{topic.name}}
                <div v-html="topic.description" v-bind:id="topic.id"></div>
            </div>
        </template>

        <h2>Projects matching "World"</h2>
        <template v-for="topic in getTopics({contains:'World'})">
            <div>
                {{topic.name}}
            </div>
        </template>

        <h2>Topic List</h2>
        <template v-for="item in items" v-if="false">
            <div>
                {{item.name}}
            </div>
        </template>
        <button @click="createNewTopic">New Topic</button>
    </div>

    <!--
    <div id="projectListDiv" class="grid">
    </div>
    -->
    <input id="createProject" type="button" value="Add Project">
    <script>

        var app = null;
        var pdb;
        var username;
        var tags;
        var items;

        function activateMCE(item) {
            let id = item.id;
            //let projDivId=id+"Div";
            let projDivId = id;
            let name = item.name;
            console.log("activateMCE", id, name, item);

            tinymce.init({
                selector: '#' + projDivId,
                height: 500,
                theme: 'modern',
                plugins: [
                    'advlist autolink lists link image charmap print preview hr anchor pagebreak',
                    'searchreplace wordcount visualblocks visualchars code fullscreen',
                    'insertdatetime media nonbreaking save table contextmenu directionality',
                    'emoticons template paste textcolor colorpicker textpattern imagetools'
                ],
                toolbar1: 'insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image',
                toolbar2: 'print preview media | forecolor backcolor emoticons',
                removed_menuitems: 'newdocument',
                image_advtab: true,
                templates: [
                    { title: 'Test template 1', content: 'Test 1' },
                    { title: 'Test template 2', content: 'Test 2' }
                ],
                content_css: [
                    '//fonts.googleapis.com/css?family=Lato:300,300i,400,400i',
                    '//www.tinymce.com/css/codepen.min.css'
                ]
            });
        }

        function completeMCE(item) {
            let id = item.id;
            //let projDivId=id+"Div";
            let projDivId = id;
            let name = item.name;
            console.log("completeMCE", id, name, item);
            //var editedDesc = tinyMCE.get('#' + projDivId).getContent()
            var editedDesc = tinyMCE.activeEditor.getContent()
            console.log("edit str", editedDesc);
            tinymce.remove('#' + projDivId);
            //var desc = $('#' + projDivId).html();
            $('#' + projDivId).html(editedDesc);
            console.log("desc:", editedDesc);
            item.description = editedDesc;
            pdb.updateDB(item);
        }

        $(document).ready(async e => {
            pdb = new WVTopicsDB();
            username = getParameterByName("username");
            tags = getParameterByName("tags");
            console.log("tags:", tags);
            pdb.allowEdits = (username != null);
            var projectId = getParameterByName("projectId");
            var projects = await pdb.getProjects({});
            items = projects;
            var editstates = {};
            items.forEach(item => editstates[item.id] = "loaded");
            app = new Vue({
                el: '#app',
                data: {
                    title: "Vue Experiment",
                    items,
                    editstates
                },
                methods: {
                    getTopics: function(opts) {
                        opts = opts || {};
                        var match = opts.contains;
                        if (!match)
                            return items;
                        return items.filter(item => item.name.indexOf(match) >= 0)
                    },
                    editTopic: function (item, action) {
                        if (action == "edit")
                            activateMCE(item);
                        else
                            completeMCE(item);
                        editstates[item.id] = action;
                    },
                    createNewTopic: () => {
                        console.log("createNewTopic");
                    },
                    editState: function (id) {
                        //console.log("editState", id, editstates[id]);
                        return editstates[id];
                    },
                    updateItems: function(items2) {
                        console.log("updateItems");
                        //items = [];
                        items.splice(0);
                        for(var i in items2) {
                            items.push(items2[i]);
                            //Vue.set(app.items, i, items2[i]);
                        }
                    }
                }
            });
            pdb.watchers.push((topicsObj) => {
                console.log("watcher", topicsObj, app);
                var topics = [];
                for (var id in topicsObj) {
                    var topic = topicsObj[id];
                    console.log("topic", id, topic);
                    topics.push(topic);
                }
                console.log("topics", topics);
                app.updateItems(topics)
            })
        });

    </script>

</html>