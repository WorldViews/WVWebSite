<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <title>WorldViews Projects</title>

    <style>
        .intro {
            background-color: rgb(208, 232, 253);
            text-align: center;
            padding-top: 30px;
            padding-right: 15%;
            padding-left: 15%;
            padding-bottom: 20px;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        body {
            background-color: aliceblue;
            padding: 0px;
            margin: 0px;
        }

        /* this applies to images inside items */
        .item img {
            border-radius: 5px;
            margin-left: 15px;
            margin-bottom: 15px;
        }

        .myobj {
            width: 400px;
            xheight: 120px;
            border-style: solid;
            border-width: 1px;
            padding: 10px;
            margin: 10px;
            xxxmargin-top: 200px;
            border-radius: 15px;
            background-color: whitesmoke;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/masonry-layout@4.1/dist/masonry.pkgd.js"></script>
    <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-database.js"></script>
    <script src="js/libs/tinymce_5.7.1/js/tinymce/tinymce.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/vue-masonry@0.11.3/dist/vue-masonry-plugin-window.js"></script>
    <script src="js/util.js"></script>
    <script src="js/sprintf.js"></script>
    <script src="js/WVTopicsDB.js"></script>
</head>

<body>
    <header>
    </header>
    <main role="main">
        <span style="float:right; padding:5px">
            <span id="userInfo">guest</span>
            &nbsp;&nbsp;
            <button id="login">login</button>
        </span>
        <img src="images/holding-hands-heart-shaped-earth-t.png" style="float:left; width: 150px; margin:20px;">
        <section class="intro">
            <h1 style="font-size: xx-large;">WorldViews Projects and Collaborations</h1>
            <p>This is a project list, for experimenting with View.</p>
        </section>
    </main>
    <div id="app">
        <h2>{{title}}</h2>
        <div v-masonry="containerId" transition-duration="0.3s" item-selector=".item" fit-width="true"
            style="margin:auto; border-style:solid; border-width:0px;">
            <div v-masonry-tile class="item" v-for="topic in getTopics()" :key="topic.id">
                <div class="myobj">
                    {{topic.name}}
                    <div v-html="topic.description" v-bind:id="topic.id"></div>
                    <br>
                    <div v-if="editState(topic.id) != 'edit' && allowEdit(topic)">
                        <button @click="editTopic(topic,'edit')">Edit</button>
                    </div>
                    <div v-if="editState(topic.id) == 'edit' && allowEdit(topic)">
                        Tags: {{ topic.tags }}
                        <button @click="editTopic(topic,'save')">Save</button>
                    </div>
                </div>
            </div>
        </div>
        <div v-if="allowEdit()">
            <!--
                <input id="createProject" type="button" value="Add Project">
            -->
            <button @click="createNewTopic()">New Topic</button>
        </div>
    </div>
    <script>
        var VueMasonryPlugin = window["vue-masonry-plugin"].VueMasonryPlugin
        Vue.use(VueMasonryPlugin);

        var app = null;
        var pdb;
        var username;
        var tags;
        var items;

        function onInitMCE(e) {
            console.log("********** onInitMCE *********");
            app.layout();
        }

        function activateMCE(item) {
            let id = item.id;
            //let projDivId=id+"Div";
            let projDivId = id;
            let name = item.name;
            console.log("activateMCE", id, name, item);

            tinymce.init({
                selector: '#' + projDivId,
                height: 500,
                //theme: 'modern'
                theme: 'silver',
                plugins: [
                    'advlist autolink lists link image charmap print preview hr anchor pagebreak',
                    'searchreplace wordcount visualblocks visualchars code fullscreen',
                    'insertdatetime media nonbreaking save table contextmenu directionality',
                    'emoticons template paste textcolor colorpicker textpattern imagetools'
                ],
                toolbar1: 'insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image',
                toolbar2: 'print preview media | forecolor backcolor emoticons',
                removed_menuitems: 'newdocument',
                image_advtab: true,
                templates: [
                    { title: 'Test template 1', content: 'Test 1' },
                    { title: 'Test template 2', content: 'Test 2' }
                ],
                init_instance_callback: onInitMCE,
                content_css: [
                    '//fonts.googleapis.com/css?family=Lato:300,300i,400,400i',
                    '//www.tinymce.com/css/codepen.min.css'
                ]
            });
        }

        function completeMCE(item) {
            let id = item.id;
            //let projDivId=id+"Div";
            let projDivId = id;
            let name = item.name;
            console.log("completeMCE", id, name, item);
            //var editedDesc = tinyMCE.get('#' + projDivId).getContent()
            var editedDesc = tinyMCE.activeEditor.getContent()
            console.log("edit str", editedDesc);
            tinymce.remove('#' + projDivId);
            //var desc = $('#' + projDivId).html();
            $('#' + projDivId).html(editedDesc);
            console.log("desc:", editedDesc);
            item.description = editedDesc;
            pdb.updateDB(item);
        }

        $(document).ready(async e => {
            pdb = new WVTopicsDB();
            username = getParameterByName("username");
            tags = getParameterByName("tags");
            console.log("tags:", tags);
            pdb.allowEdits = (username != null);
            var projectId = getParameterByName("projectId");
            var projects = await pdb.getProjects({});
            items = projects;
            var editstates = {};
            items.forEach(item => editstates[item.id] = "loaded");
            app = new Vue({
                el: '#app',
                data: {
                    title: "Vue Experiment",
                    items,
                    containerId: 'containerId',
                    editstates
                },
                methods: {
                    allowEdit: function(item) {
                        return pdb.allowEdits;
                    },
                    getTopics: function (opts) {
                        opts = opts || {};
                        var match = opts.contains;
                        if (!match)
                            return items;
                        return items.filter(item => item.name.indexOf(match) >= 0)
                    },
                    editTopic: function (item, action) {
                        console.log("editTopic", item, action);
                        editstates[item.id] = action;
                        if (action == "edit") {
                            activateMCE(item);
                            // a re-layout is needed but will be
                            // triggered by an initialization callback onInitMCE
                        }
                        else {
                            completeMCE(item);
                            setTimeout(() => this.layout(), 200);
                        }
                    },
                    createNewTopic: () => {
                        console.log("createNewTopic");
                    },
                    editState: function (id) {
                        //console.log("editState", id, editstates[id]);
                        return editstates[id];
                    },
                    updateItems: function (items2) {
                        console.log("updateItems");
                        //items = [];
                        items.splice(0);
                        for (var i in items2) {
                            items.push(items2[i]);
                            //Vue.set(app.items, i, items2[i]);
                        }
                        //https://stackoverflow.com/questions/32106155/can-you-force-vue-js-to-reload-re-render
                        // perhaps we should use computed property instead
                        this.$forceUpdate();
                    },
                    layout: function () {
                        console.log("requesting redrawVueMasonry()");
                        if (typeof this.$redrawVueMasonry === 'function') {
                            console.log("looks like function");
                        }
                        this.$redrawVueMasonry('containerId');
                    },
                    createNewTopic: function() {
                        alert("Cannot yet create new projects");
                    }
                }
            });
            pdb.watchers.push((topicsObj) => {
                console.log("watcher", topicsObj, app);
                var topics = [];
                for (var id in topicsObj) {
                    var topic = topicsObj[id];
                    console.log("topic", id, topic);
                    topics.push(topic);
                }
                console.log("topics", topics);
                app.updateItems(topics)
            })
        });

    </script>

</html>