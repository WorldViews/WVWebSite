<!DOCTYPE html>
<html>

<head>
    <title>Chat bot</title>
    <style>
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <h1>My Chatbot</h1>
    <div id="chatbox">
        <input id="chatinput" type="text" />
        <button onclick="go();">Send</button>
        &nbsp;&nbsp;&nbsp;
        <button onclick="clearChat();">Clear</button>
    </div>
    <div id="chatlog">
    </div>
    <script>
        // strict mode
        "use strict";

        let apiKey = "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";
        let response = null;
        let chatObj = null;
        let botName = "Alan Watts";

        let prompts = {};
        prompts["Alan Watts"] = [

        ]

        // get the localstorage as a json object
        function getChatObj() {
            let chatObj = JSON.parse(localStorage.getItem("chatbot"));
            // if the chatbot object is null, create a new one
            if (chatObj == null) {
                chatObj = {
                    "chatlog": []
                };
            }
            return chatObj;
        }

        // save chatObj to localstorage
        function saveChatObj(chatObj) {
            localStorage.setItem("chatbot", JSON.stringify(chatObj));
        }

        // when the user presses the clear button
        function clearChat() {
            console.log("clearChat");
            // clear the chatlog div
            $("#chatlog").html("");
            // clear the chatObj
            chatObj.chatlog = [];
            // save the chatObj to localstorage
            saveChatObj(chatObj);
        }

        async function go() {
            console.log("go");
            handleUserInput();
        }

        async function handleUserInput() {
            // get the text from the chatinput
            let text = $("#chatinput").val();
            if (text == "") {
                return;
            }
            // append text to chatlog
            $("#chatlog").append(`<p>${text}</p>\n`);
            chatObj.chatlog.push(text);
            // now ask openai for a response
            response = await callOpenAI(text);
            //let replyText = response.choices[0].text;
            let replyText = response.choices[0].message.content;
            // append text to chatlog
            $("#chatlog").append(`<p>${replyText}</p>\n`);
            // add text to chatObj
            chatObj.chatlog.push(replyText);
            // save chatObj to localstorage
            saveChatObj(chatObj);
            $("#chatinput").val("");
        }

        // call openai with a given question (or user input)
        // and return the response
        // use the v1/chat/completions endpoint
        async function callOpenAI(user_input) {
            let model = "gpt-3.5-turbo";
            let messages = [
                { "role": "system", "content": "You are a helpful assistant." },
                { "role": "user", "content": "Who won the world series in 2020?" },
                { "role": "assistant", "content": "The Los Angeles Dodgers won the World Series in 2020." },
                { "role": "user", "content": user_input }
            ];
            let rep = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model,
                    messages
                })
            });
            console.log("reply", rep);
            // get json returned by the server
            const response = await rep.json();
            console.log("response", response);
            return response;

        }

        // call openai with a given question (or user input)
        // and return the response
        async function callOpenAI_V1(question) {
            let prompt = `I am a highly intelligent question answering bot. If you ask me a  Spain.\n\n
                                Q: How many squigs are in a bonk?\nA: Unknown\n\n`;
            let full_prompt = prompt + 'Q: ' + question + '\nA:';
            let rep = await fetch("https://api.openai.com/v1/completions", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    "model": "text-davinci-003",
                    "prompt": full_prompt,
                    "temperature": 0,
                    "stop": ["\n"]
                })
            });
            console.log("reply", rep);
            // get json returned by the server
            const response = await rep.json();
            console.log("response", response);
            return response;
        }

        // when the page is loaded
        $(document).ready(function () {
            // get the chatbot object from localstorage
            chatObj = getChatObj();
            // for each item in the chatlog
            for (let i = 0; i < chatObj.chatlog.length; i++) {
                // append the item to the chatlog div
                $("#chatlog").append(`<p>${chatObj.chatlog[i]}</p>\n`);
            }
            // when the user presses enter in the chatinput
            $("#chatinput").keypress(function (e) {
                // if the key pressed is enter
                if (e.which == 13) {
                    handleUserInput();
                }
            });
        });

    </script>
</body>

</html>