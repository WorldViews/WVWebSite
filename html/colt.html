<!DOCTYPE html>
<html>

<head>
  <title>Bounded cumulative squared error</title>
  <style>
    #svgContainer {
      width: 500px;
      height: 500px;
      border: solid black 2px;
    }
  </style>
</head>

<body>
  <h1>Bounded cumulative squared error</h1>
  <div id="svgContainer"></div>

  <script>
    let boxX0 = 0;
    let boxY0 = -0.5;
    let boxWd = 1;
    let boxHt = 1;
    let mousePt = null;
    let points = [{ x: 0, y: 0 }, { x: 1, y: 0 }];

    function findPosition(x) {
      for (let i = 0; i < points.length - 1; i++) {
        let p0 = points[i];
        let p1 = points[i + 1];
        if (p0.x <= x && x <= p1.x) {
          return i;
        }
      }
      return -1;
    }

    function poly(x1, y1, x2, y2, x3, y3, x4, y4) {
      var svg =
        `<polygon points="${x1},${y1} ${x2},${y2} ${x3},${y3} ${x4},${y4}"
                fill="none" stroke="black" stroke-width="0.002" />`;
      console.log("poly:", svg);
      return svg;
    }

    // draw line
    function line(p0, p1) {
      var svg =
        `<line x1="${p0.x}" y1="${p0.y}" x2="${p1.x}" y2="${p1.y}"
               stroke="blue" stroke-width="0.002" />`;
      console.log("line:", svg);
      return svg;
    }

    function drawCircle(pt) {
      var svg =
        `<circle cx="${pt.x}" cy="${pt.y}" r="0.01" fill="red" />`;
      console.log("circle:", svg);
      return svg;
    }

    function linbox(x1, y1, x2, y2) {
      xt = (x1 + x2) / 2 - (y1 - y2) / 2;
      yt = y1 + xt - x1;
      xb = (x1 + x2) / 2 + (y1 - y2) / 2;
      yb = y1 - xb + x1;
      return poly(x1, y1, xt, yt, x2, y2, xb, yb);
    }

    function drawBoxes() {
      console.log("", points);
      var svg = `<svg xmlns="http://www.w3.org/2000/svg"
                    width="100%" height="100%"
                    viewBox="${boxX0}, ${boxY0}, ${boxWd}, ${boxHt}"
                 >\n`;
      for (let i = 0; i < points.length - 1; i++) {
        let p0 = points[i];
        let p1 = points[i + 1];
        svg += linbox(p0.x, p0.y, p1.x, p1.y);
        svg += line(p0, p1);
      }
      if (mousePt) {
        svg += drawCircle(mousePt);
      }
      svg += `</svg>\n`;

      console.log("svg:", svg);
      document.getElementById('svgContainer').innerHTML = svg;
    }

    function handleClick(event) {
      var svgContainer = document.getElementById('svgContainer');
      var svgRect = svgContainer.getBoundingClientRect();
      var svgRect = svgContainer.getBoundingClientRect();
      var x = ((event.clientX - svgRect.left) / svgRect.width) * boxWd - boxX0;
      var y = ((event.clientY - svgRect.top) / svgRect.height) * boxHt + boxY0;
      console.log("Clicked point coordinates: ", x, y);
      let i = findPosition(x);
      if (i >= 0) {
        points.splice(i + 1, 0, { x, y });
      } else {
        points.push({ x, y })
      }
      drawBoxes();
    }

    function handleMouseMove(event) {
      var svgContainer = document.getElementById('svgContainer');
      var svgRect = svgContainer.getBoundingClientRect();
      var x = ((event.clientX - svgRect.left) / svgRect.width) * boxWd - boxX0;
      var y = ((event.clientY - svgRect.top) / svgRect.height) * boxHt + boxY0;
      mousePt = { x, y };
      console.log("Mouse point coordinates: ", x, y);
      drawBoxes();
    }

    document.getElementById('svgContainer').addEventListener('click', handleClick);
    // add event handler for mouse move
    document.getElementById('svgContainer').addEventListener('mousemove', handleMouseMove); 
    drawBoxes();
  </script>
</body>

</html>